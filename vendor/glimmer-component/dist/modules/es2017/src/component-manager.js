import { CONSTANT_TAG } from '@glimmer/reference';
import { DEBUG } from '@glimmer/env';
import Bounds from './bounds';
import { RootReference, TemplateOnlyComponentDebugReference } from './references';
import { MAGIC_PROP, DESTROYING, DESTROYED } from '../addon/-private/component';
export class ComponentStateBucket {
    constructor(definition, args, owner, env) {
        let { ComponentClass, name } = definition;
        this.args = args;
        if (ComponentClass) {
            if (ComponentClass.class !== undefined) {
                ComponentClass = ComponentClass.class;
            }
            this.component = new ComponentClass(owner, this.namedArgsSnapshot());
            this.component.debugName = name;
        }
    }
    get tag() {
        return this.args.tag;
    }
    namedArgsSnapshot() {
        let snapshot = this.args.named.value();
        if (DEBUG) {
            Object.defineProperty(snapshot, MAGIC_PROP, {
                enumerable: false,
                value: true,
            });
        }
        return Object.freeze(snapshot);
    }
}
const EMPTY_SELF = new RootReference(null);
/**
 * For performance reasons, we want to avoid instantiating component buckets for
 * components that don't have an associated component class that we would need
 * instantiate and invoke lifecycle hooks on.
 *
 * In development mode, however, we need to track some state about the component
 * in order to produce more useful error messages. This
 * TemplateOnlyComponentDebugBucket is only created in development mode to hold
 * that state.
 */
export class TemplateOnlyComponentDebugBucket {
    constructor(definition) {
        this.definition = definition;
    }
}
export default class ComponentManager {
    static create(options) {
        return new ComponentManager(options);
    }
    constructor(options) {
        this.env = options.env;
    }
    prepareArgs(state, args) {
        return null;
    }
    getCapabilities(state) {
        return state.capabilities;
    }
    getJitStaticLayout(state, resolver) {
        let template = resolver.resolve(state.handle);
        let locator = template.meta;
        return resolver.compilable(locator).asLayout();
    }
    getAotStaticLayout({ name, handle, symbolTable }, resolver) {
        if (handle && symbolTable) {
            return {
                handle,
                symbolTable,
            };
        }
        throw new Error('unimplemented getAotStaticLayout');
    }
    create(_env, definition, args, _dynamicScope, _caller, _hasDefaultBlock) {
        // In development mode, if a component is template-only, save off state
        // needed for error messages. This will get stripped in production mode and
        // no bucket will be instantiated.
        if (DEBUG && !definition.ComponentClass) {
            return new TemplateOnlyComponentDebugBucket(definition);
        }
        // Only create a state bucket if the component is actually stateful. We can
        // skip this for template-only components, which are pure functions.
        if (definition.ComponentClass) {
            let owner = this.env.getOwner();
            return new ComponentStateBucket(definition, args.capture(), owner, this.env);
        }
    }
    getSelf(bucket) {
        if (DEBUG && bucket instanceof TemplateOnlyComponentDebugBucket) {
            return new TemplateOnlyComponentDebugReference(bucket.definition.name);
        }
        if (bucket) {
            return new RootReference(bucket.component);
        }
        return EMPTY_SELF;
    }
    didCreateElement(bucket, element) { }
    didRenderLayout(bucket, bounds) {
        if (DEBUG && bucket instanceof TemplateOnlyComponentDebugBucket) {
            return;
        }
        if (!bucket) {
            return;
        }
        bucket.component.bounds = new Bounds(bounds);
    }
    didCreate(bucket) {
        if (DEBUG && bucket instanceof TemplateOnlyComponentDebugBucket) {
            return;
        }
        if (!bucket) {
            return;
        }
        bucket.component.didInsertElement();
    }
    getTag(bucket) {
        if (DEBUG && bucket instanceof TemplateOnlyComponentDebugBucket) {
            return CONSTANT_TAG;
        }
        if (!bucket) {
            return CONSTANT_TAG;
        }
        return bucket.tag;
    }
    update(bucket, scope) {
        if (DEBUG && bucket instanceof TemplateOnlyComponentDebugBucket) {
            return;
        }
        if (!bucket) {
            return;
        }
        bucket.component.args = bucket.namedArgsSnapshot();
    }
    didUpdateLayout() { }
    didUpdate() { }
    getDestructor(bucket) {
        if (DEBUG && bucket instanceof TemplateOnlyComponentDebugBucket) {
            return NOOP_DESTROYABLE;
        }
        if (!bucket) {
            return NOOP_DESTROYABLE;
        }
        return {
            destroy() {
                bucket.component[DESTROYING] = true;
                bucket.component.willDestroy();
                bucket.component[DESTROYED] = true;
            },
        };
    }
}
const NOOP_DESTROYABLE = { destroy() { } };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9jb21wb25lbnQvc3JjL2NvbXBvbmVudC1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQW9CQSxPQUFPLEVBQXlDLFlBQVksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFJckMsT0FBTyxNQUFNLE1BQU0sVUFBVSxDQUFDO0FBQzlCLE9BQU8sRUFBRSxhQUFhLEVBQUUsbUNBQW1DLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFLbEYsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFNaEYsTUFBTSxPQUFPLG9CQUFvQjtJQUsvQixZQUNFLFVBQTJCLEVBQzNCLElBQXVCLEVBQ3ZCLEtBQVksRUFDWixHQUF5QjtRQUV6QixJQUFJLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxHQUFHLFVBQVUsQ0FBQztRQUMxQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUVqQixJQUFJLGNBQWMsRUFBRTtZQUNsQixJQUFJLGNBQWMsQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO2dCQUN0QyxjQUFjLEdBQUcsY0FBYyxDQUFDLEtBQUssQ0FBQzthQUN2QztZQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxjQUFjLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7WUFDckUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUVELElBQUksR0FBRztRQUNMLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDdkIsQ0FBQztJQUVELGlCQUFpQjtRQUNmLElBQUksUUFBUSxHQUFH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QUFZLGdDQUFnQyxFQUFFO1lBQy9ELE9BQU8sZ0JBQWdCLENBQUM7U0FDekI7UUFDRCxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsT0FBTyxnQkFBZ0IsQ0FBQztTQUN6QjtRQUVELE9BQU87WUFDTCxPQUFPO2dCQUNMLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsSUFBSSxDQUFDO2dCQUNwQyxNQUFNLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUMvQixNQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUNyQyxDQUFDO1NBQ0YsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQUVELE1BQU0sZ0JBQWdCLEdBQUcsRUFBRSxPQUFPLEtBQUksQ0FBQyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPd25lciB9IGZyb20gJ0BnbGltbWVyL2RpJztcbmltcG9ydCB7IFRhZyB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5pbXBvcnQge1xuICBDb21wb25lbnRNYW5hZ2VyIGFzIFZNQ29tcG9uZW50TWFuYWdlcixcbiAgUnVudGltZVJlc29sdmVyLFxuICBDb21wb25lbnRDYXBhYmlsaXRpZXMsXG4gIENhcHR1cmVkQXJndW1lbnRzLFxuICBEaWN0LFxuICBPcHRpb24sXG4gIEludm9jYXRpb24sXG4gIEVudmlyb25tZW50LFxuICBWTUFyZ3VtZW50cyxcbiAgV2l0aEFvdFN0YXRpY0xheW91dCxcbiAgRHluYW1pY1Njb3BlLFxuICBEZXN0cm95YWJsZSxcbiAgSml0UnVudGltZVJlc29sdmVyLFxuICBBb3RSdW50aW1lUmVzb2x2ZXIsXG4gIENvbXBpbGFibGVQcm9ncmFtLFxuICBCb3VuZHMgYXMgVk1Cb3VuZHMsXG59IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgVmVyc2lvbmVkUGF0aFJlZmVyZW5jZSwgUGF0aFJlZmVyZW5jZSwgQ09OU1RBTlRfVEFHIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcbmltcG9ydCB7IERFQlVHIH0gZnJvbSAnQGdsaW1tZXIvZW52JztcblxuaW1wb3J0IENvbXBvbmVudCBmcm9tICcuL2NvbXBvbmVudCc7XG5pbXBvcnQgeyBEZWZpbml0aW9uU3RhdGUgfSBmcm9tICcuL2NvbXBvbmVudC1kZWZpbml0aW9uJztcbmltcG9ydCBCb3VuZHMgZnJvbSAnLi9ib3VuZHMnO1xuaW1wb3J0IHsgUm9vdFJlZmVyZW5jZSwgVGVtcGxhdGVPbmx5Q29tcG9uZW50RGVidWdSZWZlcmVuY2UgfSBmcm9tICcuL3JlZmVyZW5jZXMnO1xuaW1wb3J0IEV4dGVuZGVkVGVtcGxhdGVNZXRhIGZyb20gJy4vdGVtcGxhdGUtbWV0YSc7XG5pbXBvcnQgeyBTZXJpYWxpemVkVGVtcGxhdGVXaXRoTGF6eUJsb2NrIH0gZnJvbSAnQGdsaW1tZXIvYXBwbGljYXRpb24vc3JjL2xvYWRlcnMvcnVudGltZS1jb21waWxlci9yZXNvbHZlcic7XG5pbXBvcnQgeyBTcGVjaWZpZXIgfSBmcm9tICdAZ2xpbW1lci9hcHBsaWNhdGlvbi9zcmMvbG9hZGVycy9ydW50aW1lLWNvbXBpbGVyL2xvYWRlcic7XG5cbmltcG9ydCB7IE1BR0lDX1BST1AsIERFU1RST1lJTkcsIERFU1RST1lFRCB9IGZyb20gJy4uL2FkZG9uLy1wcml2YXRlL2NvbXBvbmVudCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29uc3RydWN0b3JPcHRpb25zIHtcbiAgZW52OiBFbnZpcm9ubWVudFdpdGhPd25lcjtcbn1cblxuZXhwb3J0IGNsYXNzIENvbXBvbmVudFN0YXRlQnVja2V0IHtcbiAgcHVibGljIG5hbWU6IHN0cmluZztcbiAgcHVibGljIGNvbXBvbmVudDogQ29tcG9uZW50O1xuICBwcml2YXRlIGFyZ3M6IENhcHR1cmVkQXJndW1lbnRzO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGRlZmluaXRpb246IERlZmluaXRpb25TdGF0ZSxcbiAgICBhcmdzOiBDYXB0dXJlZEFyZ3VtZW50cyxcbiAgICBvd25lcjogT3duZXIsXG4gICAgZW52OiBFbnZpcm9ubWVudFdpdGhPd25lclxuICApIHtcbiAgICBsZXQgeyBDb21wb25lbnRDbGFzcywgbmFtZSB9ID0gZGVmaW5pdGlvbjtcbiAgICB0aGlzLmFyZ3MgPSBhcmdzO1xuXG4gICAgaWYgKENvbXBvbmVudENsYXNzKSB7XG4gICAgICBpZiAoQ29tcG9uZW50Q2xhc3MuY2xhc3MgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBDb21wb25lbnRDbGFzcyA9IENvbXBvbmVudENsYXNzLmNsYXNzO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNvbXBvbmVudCA9IG5ldyBDb21wb25lbnRDbGFzcyhvd25lciwgdGhpcy5uYW1lZEFyZ3NTbmFwc2hvdCgpKTtcbiAgICAgIHRoaXMuY29tcG9uZW50LmRlYnVnTmFtZSA9IG5hbWU7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHRhZygpOiBUYWcge1xuICAgIHJldHVybiB0aGlzLmFyZ3MudGFnO1xuICB9XG5cbiAgbmFtZWRBcmdzU25hcHNob3QoKTogUmVhZG9ubHk8RGljdDx1bmtub3duPj4ge1xuICAgIGxldCBzbmFwc2hvdCA9IHRoaXMuYXJncy5uYW1lZC52YWx1ZSgpO1xuXG4gICAgaWYgKERFQlVHKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc25hcHNob3QsIE1BR0lDX1BST1AsIHtcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgIHZhbHVlOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIE9iamVjdC5mcmVlemUoc25hcHNob3QpO1xuICB9XG59XG5cbmNvbnN0IEVNUFRZX1NFTEYgPSBuZXcgUm9vdFJlZmVyZW5jZShudWxsKTtcblxuLyoqXG4gKiBGb3IgcGVyZm9ybWFuY2UgcmVhc29ucywgd2Ugd2FudCB0byBhdm9pZCBpbnN0YW50aWF0aW5nIGNvbXBvbmVudCBidWNrZXRzIGZvclxuICogY29tcG9uZW50cyB0aGF0IGRvbid0IGhhdmUgYW4gYXNzb2NpYXRlZCBjb21wb25lbnQgY2xhc3MgdGhhdCB3ZSB3b3VsZCBuZWVkXG4gKiBpbnN0YW50aWF0ZSBhbmQgaW52b2tlIGxpZmVjeWNsZSBob29rcyBvbi5cbiAqXG4gKiBJbiBkZXZlbG9wbWVudCBtb2RlLCBob3dldmVyLCB3ZSBuZWVkIHRvIHRyYWNrIHNvbWUgc3RhdGUgYWJvdXQgdGhlIGNvbXBvbmVudFxuICogaW4gb3JkZXIgdG8gcHJvZHVjZSBtb3JlIHVzZWZ1bCBlcnJvciBtZXNzYWdlcy4gVGhpc1xuICogVGVtcGxhdGVPbmx5Q29tcG9uZW50RGVidWdCdWNrZXQgaXMgb25seSBjcmVhdGVkIGluIGRldmVsb3BtZW50IG1vZGUgdG8gaG9sZFxuICogdGhhdCBzdGF0ZS5cbiAqL1xuZXhwb3J0IGNsYXNzIFRlbXBsYXRlT25seUNvbXBvbmVudERlYnVnQnVja2V0IHtcbiAgY29uc3RydWN0b3IocHVibGljIGRlZmluaXRpb246IERlZmluaXRpb25TdGF0ZSkge31cbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb21waWxhYmxlUnVudGltZVJlc29sdmVyIGV4dGVuZHMgUnVudGltZVJlc29sdmVyPEV4dGVuZGVkVGVtcGxhdGVNZXRhPiB7XG4gIGNvbXBpbGVUZW1wbGF0ZShuYW1lOiBzdHJpbmcsIGxheW91dDogT3B0aW9uPG51bWJlcj4pOiBJbnZvY2F0aW9uO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVudmlyb25tZW50V2l0aE93bmVyIGV4dGVuZHMgRW52aXJvbm1lbnQge1xuICBnZXRPd25lcigpOiBPd25lcjtcbiAgc2V0T3duZXIob2JqOiBPYmplY3QsIG93bmVyOiBPd25lcik6IHZvaWQ7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbXBvbmVudE1hbmFnZXJcbiAgaW1wbGVtZW50c1xuICAgIFZNQ29tcG9uZW50TWFuYWdlcjxcbiAgICAgIENvbXBvbmVudFN0YXRlQnVja2V0IHwgVGVtcGxhdGVPbmx5Q29tcG9uZW50RGVidWdCdWNrZXQgfCB2b2lkLFxuICAgICAgRGVmaW5pdGlvblN0YXRlXG4gICAgPixcbiAgICBXaXRoQW90U3RhdGljTGF5b3V0PFxuICAgICAgQ29tcG9uZW50U3RhdGVCdWNrZXQgfCBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWJ1Z0J1Y2tldCB8IHZvaWQsXG4gICAgICBEZWZpbml0aW9uU3RhdGUsXG4gICAgICBBb3RSdW50aW1lUmVzb2x2ZXJcbiAgICA+IHtcbiAgcHJpdmF0ZSBlbnY6IEVudmlyb25tZW50V2l0aE93bmVyO1xuXG4gIHN0YXRpYyBjcmVhdGUob3B0aW9uczogQ29uc3RydWN0b3JPcHRpb25zKTogQ29tcG9uZW50TWFuYWdlciB7XG4gICAgcmV0dXJuIG5ldyBDb21wb25lbnRNYW5hZ2VyKG9wdGlvbnMpO1xuICB9XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogQ29uc3RydWN0b3JPcHRpb25zKSB7XG4gICAgdGhpcy5lbnYgPSBvcHRpb25zLmVudjtcbiAgfVxuXG4gIHByZXBhcmVBcmdzKHN0YXRlOiBEZWZpbml0aW9uU3RhdGUsIGFyZ3M6IFZNQXJndW1lbnRzKTogbnVsbCB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBnZXRDYXBhYmlsaXRpZXMoc3RhdGU6IERlZmluaXRpb25TdGF0ZSk6IENvbXBvbmVudENhcGFiaWxpdGllcyB7XG4gICAgcmV0dXJuIHN0YXRlLmNhcGFiaWxpdGllcztcbiAgfVxuXG4gIGdldEppdFN0YXRpY0xheW91dChzdGF0ZTogRGVmaW5pdGlvblN0YXRlLCByZXNvbHZlcjogSml0UnVudGltZVJlc29sdmVyKTogQ29tcGlsYWJsZVByb2dyYW0ge1xuICAgIGxldCB0ZW1wbGF0ZSA9IChyZXNvbHZlci5yZXNvbHZlKHN0YXRlLmhhbmRsZSkgYXMgdW5rbm93bikgYXMgU2VyaWFsaXplZFRlbXBsYXRlV2l0aExhenlCbG9jazxcbiAgICAgIFNwZWNpZmllclxuICAgID47XG4gICAgbGV0IGxvY2F0b3IgPSB0ZW1wbGF0ZS5tZXRhO1xuICAgIHJldHVybiByZXNvbHZlci5jb21waWxhYmxlKGxvY2F0b3IpLmFzTGF5b3V0KCk7XG4gIH1cblxuICBnZXRBb3RTdGF0aWNMYXlvdXQoXG4gICAgeyBuYW1lLCBoYW5kbGUsIHN5bWJvbFRhYmxlIH06IERlZmluaXRpb25TdGF0ZSxcbiAgICByZXNvbHZlcjogQW90UnVudGltZVJlc29sdmVyXG4gICk6IEludm9jYXRpb24ge1xuICAgIGlmIChoYW5kbGUgJiYgc3ltYm9sVGFibGUpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGhhbmRsZSxcbiAgICAgICAgc3ltYm9sVGFibGUsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHRocm93IG5ldyBFcnJvcigndW5pbXBsZW1lbnRlZCBnZXRBb3RTdGF0aWNMYXlvdXQnKTtcbiAgfVxuXG4gIGNyZWF0ZShcbiAgICBfZW52OiBFbnZpcm9ubWVudCxcbiAgICBkZWZpbml0aW9uOiBEZWZpbml0aW9uU3RhdGUsXG4gICAgYXJnczogVk1Bcmd1bWVudHMsXG4gICAgX2R5bmFtaWNTY29wZTogRHluYW1pY1Njb3BlLFxuICAgIF9jYWxsZXI6IFZlcnNpb25lZFBhdGhSZWZlcmVuY2U8dW5rbm93bj4sXG4gICAgX2hhc0RlZmF1bHRCbG9jazogYm9vbGVhblxuICApOiBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWJ1Z0J1Y2tldCB8IENvbXBvbmVudFN0YXRlQnVja2V0IHwgdm9pZCB7XG4gICAgLy8gSW4gZGV2ZWxvcG1lbnQgbW9kZSwgaWYgYSBjb21wb25lbnQgaXMgdGVtcGxhdGUtb25seSwgc2F2ZSBvZmYgc3RhdGVcbiAgICAvLyBuZWVkZWQgZm9yIGVycm9yIG1lc3NhZ2VzLiBUaGlzIHdpbGwgZ2V0IHN0cmlwcGVkIGluIHByb2R1Y3Rpb24gbW9kZSBhbmRcbiAgICAvLyBubyBidWNrZXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQuXG4gICAgaWYgKERFQlVHICYmICFkZWZpbml0aW9uLkNvbXBvbmVudENsYXNzKSB7XG4gICAgICByZXR1cm4gbmV3IFRlbXBsYXRlT25seUNvbXBvbmVudERlYnVnQnVja2V0KGRlZmluaXRpb24pO1xuICAgIH1cblxuICAgIC8vIE9ubHkgY3JlYXRlIGEgc3RhdGUgYnVja2V0IGlmIHRoZSBjb21wb25lbnQgaXMgYWN0dWFsbHkgc3RhdGVmdWwuIFdlIGNhblxuICAgIC8vIHNraXAgdGhpcyBmb3IgdGVtcGxhdGUtb25seSBjb21wb25lbnRzLCB3aGljaCBhcmUgcHVyZSBmdW5jdGlvbnMuXG4gICAgaWYgKGRlZmluaXRpb24uQ29tcG9uZW50Q2xhc3MpIHtcbiAgICAgIGxldCBvd25lciA9IHRoaXMuZW52LmdldE93bmVyKCk7XG4gICAgICByZXR1cm4gbmV3IENvbXBvbmVudFN0YXRlQnVja2V0KGRlZmluaXRpb24sIGFyZ3MuY2FwdHVyZSgpLCBvd25lciwgdGhpcy5lbnYpO1xuICAgIH1cbiAgfVxuXG4gIGdldFNlbGYoYnVja2V0OiBDb21wb25lbnRTdGF0ZUJ1Y2tldCk6IFBhdGhSZWZlcmVuY2Uge1xuICAgIGlmIChERUJVRyAmJiBidWNrZXQgaW5zdGFuY2VvZiBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWJ1Z0J1Y2tldCkge1xuICAgICAgcmV0dXJuIG5ldyBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWJ1Z1JlZmVyZW5jZShidWNrZXQuZGVmaW5pdGlvbi5uYW1lKTtcbiAgICB9XG4gICAgaWYgKGJ1Y2tldCkge1xuICAgICAgcmV0dXJuIG5ldyBSb290UmVmZXJlbmNlKGJ1Y2tldC5jb21wb25lbnQpO1xuICAgIH1cbiAgICByZXR1cm4gRU1QVFlfU0VMRjtcbiAgfVxuXG4gIGRpZENyZWF0ZUVsZW1lbnQoYnVja2V0OiBDb21wb25lbnRTdGF0ZUJ1Y2tldCwgZWxlbWVudDogSFRNTEVsZW1lbnQpIHt9XG5cbiAgZGlkUmVuZGVyTGF5b3V0KGJ1Y2tldDogQ29tcG9uZW50U3RhdGVCdWNrZXQsIGJvdW5kczogVk1Cb3VuZHMpIHtcbiAgICBpZiAoREVCVUcgJiYgYnVja2V0IGluc3RhbmNlb2YgVGVtcGxhdGVPbmx5Q29tcG9uZW50RGVidWdCdWNrZXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCFidWNrZXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYnVja2V0LmNvbXBvbmVudC5ib3VuZHMgPSBuZXcgQm91bmRzKGJvdW5kcyk7XG4gIH1cblxuICBkaWRDcmVhdGUoYnVja2V0OiBDb21wb25lbnRTdGF0ZUJ1Y2tldCkge1xuICAgIGlmIChERUJVRyAmJiBidWNrZXQgaW5zdGFuY2VvZiBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWJ1Z0J1Y2tldCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIWJ1Y2tldCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBidWNrZXQuY29tcG9uZW50LmRpZEluc2VydEVsZW1lbnQoKTtcbiAgfVxuXG4gIGdldFRhZyhidWNrZXQ6IENvbXBvbmVudFN0YXRlQnVja2V0KTogVGFnIHtcbiAgICBpZiAoREVCVUcgJiYgYnVja2V0IGluc3RhbmNlb2YgVGVtcGxhdGVPbmx5Q29tcG9uZW50RGVidWdCdWNrZXQpIHtcbiAgICAgIHJldHVybiBDT05TVEFOVF9UQUc7XG4gICAgfVxuICAgIGlmICghYnVja2V0KSB7XG4gICAgICByZXR1cm4gQ09OU1RBTlRfVEFHO1xuICAgIH1cbiAgICByZXR1cm4gYnVja2V0LnRhZztcbiAgfVxuXG4gIHVwZGF0ZShidWNrZXQ6IENvbXBvbmVudFN0YXRlQnVja2V0LCBzY29wZTogRHluYW1pY1Njb3BlKSB7XG4gICAgaWYgKERFQlVHICYmIGJ1Y2tldCBpbnN0YW5jZW9mIFRlbXBsYXRlT25seUNvbXBvbmVudERlYnVnQnVja2V0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghYnVja2V0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgYnVja2V0LmNvbXBvbmVudC5hcmdzID0gYnVja2V0Lm5hbWVkQXJnc1NuYXBzaG90KCk7XG4gIH1cblxuICBkaWRVcGRhdGVMYXlvdXQoKSB7fVxuXG4gIGRpZFVwZGF0ZSgpIHt9XG5cbiAgZ2V0RGVzdHJ1Y3RvcihidWNrZXQ6IENvbXBvbmVudFN0YXRlQnVja2V0KTogRGVzdHJveWFibGUge1xuICAgIGlmIChERUJVRyAmJiBidWNrZXQgaW5zdGFuY2VvZiBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWJ1Z0J1Y2tldCkge1xuICAgICAgcmV0dXJuIE5PT1BfREVTVFJPWUFCTEU7XG4gICAgfVxuICAgIGlmICghYnVja2V0KSB7XG4gICAgICByZXR1cm4gTk9PUF9ERVNUUk9ZQUJMRTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgZGVzdHJveSgpIHtcbiAgICAgICAgYnVja2V0LmNvbXBvbmVudFtERVNUUk9ZSU5HXSA9IHRydWU7XG4gICAgICAgIGJ1Y2tldC5jb21wb25lbnQud2lsbERlc3Ryb3koKTtcbiAgICAgICAgYnVja2V0LmNvbXBvbmVudFtERVNUUk9ZRURdID0gdHJ1ZTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxufVxuXG5jb25zdCBOT09QX0RFU1RST1lBQkxFID0geyBkZXN0cm95KCkge30gfTtcbiJdfQ==